<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Calendario di Letizia üéÑ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg1:#3e1026;
      --bg2:#120810;
      --bg3:#050308;
      --card:rgba(255,255,255,0.96);
      --ink:#2b1620;
      --muted:#6b4b57;
      --accent:#cc4b4b;
      --accent2:#8c2b2b;
      --shadow:0 20px 40px rgba(0,0,0,0.35);
      --r22:22px;
      --r16:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top left,var(--bg1),var(--bg2) 60%,var(--bg3));
      color:#fff;
      display:flex;
      justify-content:center;
      padding:1rem;
    }
    main{width:100%;max-width:1100px}
    h1{margin:0 0 .5rem;font-size:2.2rem}
    .subtitle{
      opacity:.92;
      margin:0 0 1.2rem;
      line-height:1.35rem;
      max-width:980px;
    }
    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:1rem;
      margin-bottom:.75rem;
    }
    /* meta removed from UI in v8 (kept only in console) */
    .meta{display:none}

    .calendar-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:1rem;
    }
    .day-card{
      background:var(--card);
      color:var(--ink);
      border-radius:var(--r22);
      padding:.9rem;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .day-title{
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.08em;
      font-size:.78rem;
      color:var(--accent2);
      margin-bottom:.55rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .badge{
      font-weight:700;
      font-size:.72rem;
      padding:.14rem .5rem;
      border-radius:999px;
      background:rgba(204,75,75,.12);
      color:var(--accent2);
    }
    .scratch-container{
      position:relative;
      border-radius:var(--r16);
      overflow:hidden;
      background:#f5f0eb;
      min-height:220px;
    }
    .gift-content{
      padding:.7rem;
      text-align:center;
      filter: blur(10px);
      opacity: 0.02;
      transition: filter .35s ease, opacity .35s ease;
      user-select:none;
    }
    .scratch-container.revealed .gift-content{
      filter:none;
      opacity:1;
      user-select:auto;
    }

    .gift-image{
      max-width:100%;
      max-height:180px;
      object-fit:contain;
      border-radius:12px;
      margin:0 auto .45rem;
      display:block;
      box-shadow:0 10px 24px rgba(0,0,0,.12);
    }
    .gift-image.placeholder{display:none}
    .gift-caption{
      font-size:.92rem;
      color:var(--muted);
      line-height:1.25rem;
    }

    canvas.scratch{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      touch-action:none;
      cursor:pointer;
      transition:opacity .35s ease;
      opacity:1;
      pointer-events:auto;
    }
    canvas.scratch.hidden{
      opacity:0;
      pointer-events:none;
    }

    .locked-hint{
      position:absolute;
      inset:auto 0 0 0;
      padding:.5rem .65rem;
      font-size:.78rem;
      color:rgba(255,255,255,.95);
      background:linear-gradient(135deg, rgba(140,43,43,.9), rgba(204,75,75,.8));
      text-align:center;
      pointer-events:none;
    }

    .error-banner{
      margin:.6rem 0 1rem;
      padding:.6rem .75rem;
      border-radius:14px;
      background:rgba(255,255,255,0.14);
      border:1px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(10px);
      display:none;
    }

    .sparkle{
      position:absolute;
      left:50%;
      top:50%;
      width:6px;
      height:6px;
      border-radius:999px;
      background:#fff;
      pointer-events:none;
      opacity:0;
      transform:translate(-50%,-50%);
    }
    .sparkle.run{
      opacity:1;
      animation: pop 900ms ease-out forwards;
    }
    @keyframes pop{
      0%{transform:translate(-50%,-50%) scale(.7);opacity:0}
      15%{opacity:1}
      100%{transform:translate(-50%,-50%) scale(1.15);opacity:0}
    }
    .sparkle i{
      position:absolute;
      left:50%;
      top:50%;
      width:4px;
      height:18px;
      border-radius:999px;
      background:#fff;
      transform-origin:50% 100%;
      opacity:.9;
    }
    .sparkle i:nth-child(1){transform:translate(-50%,-100%) rotate(0deg)}
    .sparkle i:nth-child(2){transform:translate(-50%,-100%) rotate(30deg)}
    .sparkle i:nth-child(3){transform:translate(-50%,-100%) rotate(60deg)}
    .sparkle i:nth-child(4){transform:translate(-50%,-100%) rotate(90deg)}
    .sparkle i:nth-child(5){transform:translate(-50%,-100%) rotate(120deg)}
    .sparkle i:nth-child(6){transform:translate(-50%,-100%) rotate(150deg)}
    .sparkle i:nth-child(7){transform:translate(-50%,-100%) rotate(180deg)}
    .sparkle i:nth-child(8){transform:translate(-50%,-100%) rotate(210deg)}
    .sparkle i:nth-child(9){transform:translate(-50%,-100%) rotate(240deg)}
    .sparkle i:nth-child(10){transform:translate(-50%,-100%) rotate(270deg)}
    .sparkle i:nth-child(11){transform:translate(-50%,-100%) rotate(300deg)}
    .sparkle i:nth-child(12){transform:translate(-50%,-100%) rotate(330deg)}

    #admin{
      position:fixed;
      bottom:1rem;
      right:1rem;
      background:rgba(255,255,255,0.98);
      color:var(--ink);
      padding:.85rem;
      border-radius:18px;
      box-shadow:0 20px 44px rgba(0,0,0,0.45);
      font-size:.82rem;
      max-width:330px;
      z-index:10;
    }
    #admin.hidden{display:none}
    #admin .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:.6rem;
      margin-bottom:.2rem;
    }
    #admin .pill{
      font-size:.7rem;
      padding:.12rem .5rem;
      border-radius:999px;
      background:rgba(204,75,75,.12);
      color:var(--accent2);
      font-weight:700;
      white-space:nowrap;
    }
    #admin label{
      display:block;
      margin-top:.45rem;
      opacity:.75;
      font-size:.78rem;
    }
    #admin input,#admin textarea,#admin select{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.12);
      padding:.35rem .45rem;
      font-family:inherit;
      font-size:.82rem;
      outline:none;
      background:#faf7f4;
    }
    #admin textarea{resize:vertical;min-height:56px}
    #admin .btns{display:flex;gap:.4rem;margin-top:.55rem;flex-wrap:wrap}
    #admin button{
      border:none;
      border-radius:999px;
      padding:.4rem .6rem;
      cursor:pointer;
      font-weight:700;
      font-family:inherit;
      font-size:.8rem;
      flex:1 1 auto;
      white-space:nowrap;
    }
    #admin .primary{
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#fff;
    }
    #admin .secondary{
      background:#eee;
      color:#333;
    }

    @media (max-width:720px){
      .topbar{flex-direction:column;align-items:flex-start}
      #admin{left:.8rem;right:.8rem;max-width:none}
    }
  </style>
</head>

<body>
  <main>
    <div class="topbar">
      <div>
        <h1>üéÅ Calendario di Letizia</h1>
        <p class="subtitle">
          Ci sono un sacco di studi che ci dicono quanto la Felicit√† sia pi√π influenzata da piccoli gesti quotidiani, rispetto a grandi occasioni saltuarie.<br/>
          E' per questo che, come tu mi hai portato il sole in questi mesi, prover√≤ a strapparti una settimana di sorrisi, anche a distanza.<br/>
          Dal 18 al 25 dicembre, ogni giorno un regalino da grattare ‚ù§Ô∏è
        </p>
      </div>
      <div class="meta" id="meta"></div>
    </div>

    <div class="error-banner" id="errorBanner">
      <strong>‚ö†Ô∏è Non riesco a caricare dal JSON</strong><br />
      Assicurati che <code>gifts.json</code> esista nella stessa cartella di <code>index.html</code>.
    </div>

    <section id="calendar" class="calendar-grid"></section>
  </main>

  <div id="admin" class="hidden">
    <div class="row">
      <strong>Modalit√† Fra</strong>
      <span class="pill">admin</span>
    </div>

    <label for="a-day">Giorno</label>
    <select id="a-day"></select>

    <label for="a-img">URL immagine</label>
    <input id="a-img" placeholder="https://..." />

    <label for="a-cap">Didascalia</label>
    <textarea id="a-cap" placeholder="Testo sotto l'immagine"></textarea>

    <div class="btns">
      <button id="a-save" class="primary">Salva override locale</button>
      <button id="a-clear" class="secondary">Rimuovi override</button>
      <button id="a-reset" class="secondary">Reset grattata</button>
      <button id="a-reset-all" class="secondary">Reset tutte</button>
    </div>
  </div>

<script>
(() => {
  // ===== VERSIONING =====
  const APP_VERSION = 8;
  console.log("[Calendar] version =", APP_VERSION);

  // ===== CONFIG =====
  // v8: days 18..25 (8 giorni)
  const DAYS = [18,19,20,21,22,23,24,25];
  const CONFIG_URL = "./gifts.json";
  const OVERRIDE_KEY = "calendar_overrides_v1";
  const REVEALED_KEY = "calendar_revealed_v8";
  const REVEALED_COOKIE = "cal_revealed_v8";
  const TIMEZONE = "Europe/Rome";
  const SCRATCH_THRESHOLD = 85;
  const INCLUDE_TODAY_PUBLIC = true;

  // lock messages updated for 18..25
  const LOCK_MESSAGES = {
    "18": "Dai Le, aspetta il 18 üëÄ",
    "19": "Piano piano‚Ä¶ il 19 arriva üíõ",
    "20": "Ancora un po‚Äô: ci vediamo il 20 ‚ú®",
    "21": "No spoiler üòá si sblocca il 21",
    "22": "Resisti‚Ä¶ manca poco al 22 üòç",
    "23": "Quasi! Il 23 √® dietro l‚Äôangolo üéÅ",
    "24": "Il gran finale √® il 24 üéÑ",
    "25": "Buon Natale amore ‚ù§Ô∏è si apre il 25"
  };

  // ===== STORAGE (localStorage + cookie fallback) =====
  function safeJsonParse(str, fallback) {
    try { return JSON.parse(str); } catch { return fallback; }
  }
  function storageGet(key, fallback) {
    try {
      const v = localStorage.getItem(key);
      return v == null ? fallback : v;
    } catch {
      return fallback;
    }
  }
  function storageSet(key, value) {
    try { localStorage.setItem(key, value); return true; } catch { return false; }
  }
  function setCookie(name, value, days) {
    try {
      const d = new Date();
      d.setTime(d.getTime() + days*24*60*60*1000);
      document.cookie = `${encodeURIComponent(name)}=${encodeURIComponent(value)}; expires=${d.toUTCString()}; path=/; SameSite=Lax`;
      return true;
    } catch { return false; }
  }
  function getCookie(name) {
    try {
      const target = encodeURIComponent(name) + "=";
      const parts = document.cookie.split(";").map(s => s.trim());
      for (const p of parts) if (p.startsWith(target)) return decodeURIComponent(p.slice(target.length));
      return "";
    } catch { return ""; }
  }
  function loadRevealedFromCookie() {
    const raw = getCookie(REVEALED_COOKIE);
    if (!raw) return {};
    const days = raw.split(",").map(s => s.trim()).filter(Boolean);
    const obj = {};
    for (const d of days) obj[d] = true;
    return obj;
  }
  function saveRevealedToCookie(revealedObj) {
    const list = Object.keys(revealedObj).filter(k => revealedObj[k]).sort((a,b)=>Number(a)-Number(b));
    setCookie(REVEALED_COOKIE, list.join(","), 400);
  }

  // ===== TIME =====
  function nowInRomeParts() {
    const fmt = new Intl.DateTimeFormat("it-IT", { timeZone: TIMEZONE, year: "numeric", month: "2-digit", day: "2-digit" });
    const parts = fmt.formatToParts(new Date());
    const get = (t) => parts.find(p => p.type === t)?.value;
    return { year: Number(get("year")), month: Number(get("month")), day: Number(get("day")) };
  }
  function canRevealPublic(dayNumber, baseYear, includeToday) {
    const { year, month, day } = nowInRomeParts();
    const y = baseYear ?? year;
    if (year > y) return true;
    if (year < y) return false;
    if (month > 12) return true;
    if (month < 12) return false;
    return includeToday ? (day >= dayNumber) : (day > dayNumber);
  }
  function lockMessageForDay(dayNum) {
    return LOCK_MESSAGES[String(dayNum)] || `Dai Le, aspetta il ${dayNum} üòâ`;
  }

  // ===== STATE =====
  const overrides = safeJsonParse(storageGet(OVERRIDE_KEY, "{}"), {});
  const revealedFromLS = safeJsonParse(storageGet(REVEALED_KEY, "{}"), {});
  const revealedFromCookie = loadRevealedFromCookie();
  const revealed = (() => {
    const out = {};
    for (const k of Object.keys(revealedFromLS)) out[k] = !!revealedFromLS[k];
    for (const k of Object.keys(revealedFromCookie)) out[k] = out[k] || !!revealedFromCookie[k];
    return out;
  })();
  let remoteGifts = {};

  function saveState() {
    storageSet(OVERRIDE_KEY, JSON.stringify(overrides));
    storageSet(REVEALED_KEY, JSON.stringify(revealed));
    saveRevealedToCookie(revealed);
  }

  function giftFor(day) {
    const key = String(day);
    return overrides[key] || remoteGifts[key] || {};
  }

  async function fetchRemoteGifts() {
    const banner = document.getElementById("errorBanner");
    try {
      const res = await fetch(CONFIG_URL + (CONFIG_URL.includes("?") ? "&" : "?") + "v=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const json = await res.json();
      if (banner) banner.style.display = "none";
      return json && json.gifts ? json.gifts : {};
    } catch (e) {
      console.warn("[Calendar] gifts.json non caricato:", e?.message || e);
      if (banner) banner.style.display = "block";
      return {};
    }
  }

  // ===== UI =====
  function ensureCalendarEl() {
    let el = document.getElementById("calendar");
    if (!el) {
      el = document.createElement("section");
      el.id = "calendar";
      el.className = "calendar-grid";
      document.querySelector("main")?.appendChild(el) || document.body.appendChild(el);
    }
    return el;
  }
  function makeSparkle() {
    const s = document.createElement("div");
    s.className = "sparkle";
    for (let i=0;i<12;i++) s.appendChild(document.createElement("i"));
    return s;
  }
  function computeScratchedPercentSample(ctx, canvas) {
    try {
      const w = canvas.width, h = canvas.height;
      const data = ctx.getImageData(0, 0, w, h).data;
      const step = Math.max(8, Math.floor(Math.min(w,h) / 120));
      let transparent = 0, total = 0;
      for (let y=0; y<h; y+=step) {
        for (let x=0; x<w; x+=step) {
          const a = data[(y*w + x)*4 + 3];
          total++;
          if (a === 0) transparent++;
        }
      }
      return (transparent/total)*100;
    } catch { return 0; }
  }

  function initScratchOverlay(canvas, ctx, labelText) {
    const rect = canvas.parentElement.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.max(1, Math.floor(rect.width * dpr));
    canvas.height = Math.max(1, Math.floor(rect.height * dpr));
    canvas.style.width = rect.width + "px";
    canvas.style.height = rect.height + "px";

    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const w = canvas.width, h = canvas.height;
    const grad = ctx.createLinearGradient(0,0,w,h);
    grad.addColorStop(0, "#b54a4a");
    grad.addColorStop(1, "#8c2b2b");
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,w,h);

    ctx.fillStyle = "rgba(255,255,255,0.92)";
    ctx.font = `${Math.max(16, Math.floor(18*dpr))}px system-ui, -apple-system, Segoe UI, sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    const maxWidth = w * 0.82;
    const words = String(labelText).split(" ");
    let line = "";
    const lines = [];
    for (const word of words) {
      const test = line ? (line + " " + word) : word;
      if (ctx.measureText(test).width > maxWidth && line) {
        lines.push(line);
        line = word;
      } else {
        line = test;
      }
    }
    if (line) lines.push(line);

    const lineH = Math.max(20, Math.floor(22*dpr));
    const startY = h/2 - (lines.length-1)*lineH/2;
    lines.forEach((l,i)=>ctx.fillText(l, w/2, startY + i*lineH));

    canvas.classList.remove("hidden");
    canvas.style.pointerEvents = "auto";
  }

  // ===== LOG ONLY (no UI meta) =====
  function logMeta(isAdmin, targetYear) {
    const { year, month, day } = nowInRomeParts();
    const mm = String(month).padStart(2,"0");
    const dd = String(day).padStart(2,"0");
    const revealedCount = Object.keys(revealed).filter(k => revealed[k]).length;

    let lsOk = true;
    try { const t="__t"; localStorage.setItem(t,"1"); localStorage.removeItem(t); } catch { lsOk = false; }

    console.log("[Calendar meta]", {
      version: APP_VERSION,
      todayRome: `${dd}/${mm}/${year}`,
      targetYear,
      revealedCount,
      localStorage: lsOk ? "ok" : "blocked",
      admin: isAdmin
    });
  }

  function createCard(day, opts) {
    const { isAdmin, targetYear } = opts;

    const card = document.createElement("article");
    card.className = "day-card";
    card.dataset.day = String(day);

    card.innerHTML = `
      <div class="day-title">
        <span>Giorno ${day}</span>
        <span class="badge">Dic</span>
      </div>
      <div class="scratch-container">
        <div class="gift-content">
          <img class="gift-image placeholder" alt="Regalo del ${day} dicembre" />
          <div class="gift-caption">Regalino del ${day} dicembre ‚ú®</div>
        </div>
        <canvas class="scratch"></canvas>
      </div>
    `;

    const container = card.querySelector(".scratch-container");
    const img = card.querySelector(".gift-image");
    const cap = card.querySelector(".gift-caption");
    let canvas = card.querySelector("canvas.scratch");
    let ctx = canvas.getContext("2d");

    const sparkle = makeSparkle();
    container.appendChild(sparkle);

    let lockedHintEl = null;
    function setLockedHint(text) {
      if (!lockedHintEl) {
        lockedHintEl = document.createElement("div");
        lockedHintEl.className = "locked-hint";
        container.appendChild(lockedHintEl);
      }
      lockedHintEl.textContent = text;
      lockedHintEl.style.display = "block";
    }
    function clearLockedHint() {
      if (lockedHintEl) lockedHintEl.style.display = "none";
    }

    function renderGift() {
      const g = giftFor(day);
      if (g.imageUrl) { img.src = g.imageUrl; img.classList.remove("placeholder"); }
      else { img.removeAttribute("src"); img.classList.add("placeholder"); }
      cap.textContent = g.caption || `Regalino del ${day} dicembre ‚ú®`;
    }

    function isRevealed() { return !!revealed[String(day)]; }

    function isRevealAllowedNow() {
      if (isAdmin) return true;
      return canRevealPublic(day, targetYear, INCLUDE_TODAY_PUBLIC);
    }

    function setRevealedUI(on) {
      if (on) container.classList.add("revealed");
      else container.classList.remove("revealed");
    }

    function reveal() {
      revealed[String(day)] = true;
      saveState();
      canvas.classList.add("hidden");
      setRevealedUI(true);

      sparkle.classList.remove("run");
      void sparkle.offsetWidth;
      sparkle.classList.add("run");
      setTimeout(()=>sparkle.classList.remove("run"), 950);
    }

    function bindScratch(c, cctx) {
      let drawing = false;

      function scratchAt(clientX, clientY) {
        const r = c.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        const x = (clientX - r.left) * dpr;
        const y = (clientY - r.top) * dpr;

        cctx.globalCompositeOperation = "destination-out";
        cctx.beginPath();
        cctx.arc(x, y, 18 * dpr, 0, Math.PI * 2);
        cctx.fill();
      }

      function maybeRevealOrRestore() {
        const allowed = isRevealAllowedNow();
        const pct = computeScratchedPercentSample(cctx, c);

        if (!allowed) {
          const msg = lockMessageForDay(day);
          initScratchOverlay(c, cctx, msg);
          setRevealedUI(false);
          setLockedHint(msg);
          return;
        }

        if (pct >= SCRATCH_THRESHOLD) reveal();
      }

      c.addEventListener("pointerdown", (e) => {
        e.preventDefault();
        drawing = true;
        try { c.setPointerCapture(e.pointerId); } catch {}
        scratchAt(e.clientX, e.clientY);
      });

      c.addEventListener("pointermove", (e) => {
        if (!drawing) return;
        e.preventDefault();
        scratchAt(e.clientX, e.clientY);
      });

      c.addEventListener("pointerup", (e) => {
        if (!drawing) return;
        drawing = false;
        try { c.releasePointerCapture(e.pointerId); } catch {}
        maybeRevealOrRestore();
      });

      c.addEventListener("pointerleave", () => {
        if (!drawing) return;
        drawing = false;
        maybeRevealOrRestore();
      });

      window.addEventListener("resize", () => {
        if (isRevealed()) return;
        const allowed = isRevealAllowedNow();
        initScratchOverlay(c, cctx, allowed ? `Gratta il ${day}` : lockMessageForDay(day));
        if (!allowed) setLockedHint(lockMessageForDay(day));
      }, { passive:true });
    }

    function attachOverlay() {
      setRevealedUI(isRevealed());

      if (isRevealed()) {
        canvas.classList.add("hidden");
        canvas.style.pointerEvents = "none";
        clearLockedHint();
        return;
      }

      canvas.classList.remove("hidden");
      canvas.style.pointerEvents = "auto";

      const allowed = isRevealAllowedNow();
      if (allowed) {
        clearLockedHint();
        initScratchOverlay(canvas, ctx, `Gratta il ${day}`);
      } else {
        const msg = lockMessageForDay(day);
        initScratchOverlay(canvas, ctx, msg);
        setLockedHint(msg);
      }

      bindScratch(canvas, ctx);
    }

    function resetScratch() {
      delete revealed[String(day)];
      saveState();

      const newCanvas = canvas.cloneNode(true);
      canvas.parentElement.replaceChild(newCanvas, canvas);
      canvas = newCanvas;
      ctx = canvas.getContext("2d");

      attachOverlay();
    }

    renderGift();
    attachOverlay();

    return { card, renderGift, resetScratch, attachOverlay };
  }

  function setupAdmin(isAdmin, cardsByDay) {
    if (!isAdmin) return;

    const admin = document.getElementById("admin");
    admin.classList.remove("hidden");

    const sel = document.getElementById("a-day");
    const img = document.getElementById("a-img");
    const cap = document.getElementById("a-cap");

    sel.innerHTML = "";
    DAYS.forEach(d => {
      const o = document.createElement("option");
      o.value = String(d);
      o.textContent = `Giorno ${d}`;
      sel.appendChild(o);
    });

    function loadForm() {
      const day = sel.value;
      const g = overrides[day] || remoteGifts[day] || {};
      img.value = g.imageUrl || "";
      cap.value = g.caption || "";
    }
    sel.addEventListener("change", loadForm);
    loadForm();

    document.getElementById("a-save").onclick = () => {
      overrides[sel.value] = { imageUrl: img.value.trim(), caption: cap.value.trim() };
      saveState();
      const api = cardsByDay.get(Number(sel.value));
      api?.renderGift();
      api?.attachOverlay();
      alert("Override salvato (locale).");
    };

    document.getElementById("a-clear").onclick = () => {
      delete overrides[sel.value];
      saveState();
      const api = cardsByDay.get(Number(sel.value));
      api?.renderGift();
      api?.attachOverlay();
      alert("Override rimosso.");
    };

    document.getElementById("a-reset").onclick = () => {
      cardsByDay.get(Number(sel.value))?.resetScratch?.();
      alert("Grattata resettata.");
    };

    document.getElementById("a-reset-all").onclick = () => {
      for (const k of Object.keys(revealed)) delete revealed[k];
      saveState();
      DAYS.forEach(d => cardsByDay.get(d)?.resetScratch?.());
      alert("Tutte le grattate resettate.");
    };
  }

  async function boot() {
    if (document.readyState === "loading") {
      await new Promise(r => document.addEventListener("DOMContentLoaded", r, { once:true }));
    }

    const params = new URLSearchParams(location.search);
    const isAdmin = params.get("test") === "fra";

    const targetYear = (() => {
      const y = Number(params.get("year"));
      if (Number.isFinite(y) && y > 2000 && y < 2100) return y;
      return nowInRomeParts().year;
    })();

    logMeta(isAdmin, targetYear);

    const calendarEl = document.getElementById("calendar");
    calendarEl.innerHTML = "";

    remoteGifts = await fetchRemoteGifts();

    const cardsByDay = new Map();
    DAYS.forEach(day => {
      const api = createCard(day, { isAdmin, targetYear });
      calendarEl.appendChild(api.card);
      cardsByDay.set(day, api);
    });

    setupAdmin(isAdmin, cardsByDay);
  }

  boot();
})();
</script>
</body>
</html>
