<script>
  (function () {
    const DAYS = [16, 17, 18, 19, 20, 21, 22, 23, 24];

    // JSON remoto (consigliato: file gifts.json nello stesso repo)
    const CONFIG_URL = "./gifts.json";

    // Override locale (solo per admin edit dal browser)
    const STORAGE_KEY = "letiziaAdventOverrides_v1";
    const REVEALED_KEY = "letiziaAdventRevealed_v1";

    function loadOverrides() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
      } catch {
        return {};
      }
    }

    function saveOverrides(overrides) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(overrides));
      } catch {}
    }

    function loadRevealed() {
      try {
        return JSON.parse(localStorage.getItem(REVEALED_KEY) || "{}");
      } catch {
        return {};
      }
    }

    function saveRevealed(revealed) {
      try {
        localStorage.setItem(REVEALED_KEY, JSON.stringify(revealed));
      } catch {}
    }

    async function fetchRemoteConfig() {
      try {
        // cache busting leggero (evita cache aggressiva)
        const url = CONFIG_URL + (CONFIG_URL.includes("?") ? "&" : "?") + "v=" + Date.now();
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const json = await res.json();
        return (json && json.gifts) ? json.gifts : {};
      } catch (e) {
        // se fallisce, continuiamo con vuoto
        return {};
      }
    }

    // stato runtime
    let remoteGifts = {};
    let overrides = loadOverrides();
    let revealed = loadRevealed();

    const cardsByDay = new Map();
    const scratchAPIs = new Map();

    function getGiftForDay(day) {
      // override locale vince su remoto
      return overrides[String(day)] || remoteGifts[String(day)] || {};
    }

    function createCalendar() {
      const calendar = document.getElementById("calendar");
      DAYS.forEach((day) => {
        const card = document.createElement("article");
        card.className = "day-card";
        card.dataset.day = String(day);

        const title = document.createElement("div");
        title.className = "day-title";
        title.textContent = "Giorno " + day;
        const badge = document.createElement("span");
        badge.className = "badge";
        badge.textContent = "Dicembre";
        title.appendChild(badge);

        const container = document.createElement("div");
        container.className = "scratch-container";

        const content = document.createElement("div");
        content.className = "gift-content";

        const img = document.createElement("img");
        img.className = "gift-image";
        img.alt = "Regalo del " + day + " dicembre";

        const caption = document.createElement("div");
        caption.className = "gift-caption";

        content.appendChild(img);
        content.appendChild(caption);

        const canvas = document.createElement("canvas");
        canvas.className = "scratch-canvas";

        container.appendChild(content);
        container.appendChild(canvas);
        card.appendChild(title);
        card.appendChild(container);
        calendar.appendChild(card);

        cardsByDay.set(day, card);
      });
    }

    function renderGift(day) {
      const card = cardsByDay.get(day);
      if (!card) return;

      const gift = getGiftForDay(day);
      const img = card.querySelector(".gift-image");
      const cap = card.querySelector(".gift-caption");

      if (gift.imageUrl) {
        img.src = gift.imageUrl;
        img.classList.remove("placeholder");
      } else {
        img.removeAttribute("src");
        img.classList.add("placeholder");
      }

      cap.textContent = gift.caption || ("Regalino del " + day + " dicembre ✨");
    }

    function setupScratchForDay(day) {
      const card = cardsByDay.get(day);
      const container = card.querySelector(".scratch-container");
      const canvas = card.querySelector(".scratch-canvas");
      const ctx = canvas.getContext("2d");
      let isDrawing = false;

      function initOverlay() {
        const rect = container.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;

        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        canvas.style.width = rect.width + "px";
        canvas.style.height = rect.height + "px";

        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        ctx.globalCompositeOperation = "source-over";
        ctx.clearRect(0, 0, rect.width, rect.height);

        const grad = ctx.createLinearGradient(0, 0, rect.width, rect.height);
        grad.addColorStop(0, "#b54a4a");
        grad.addColorStop(1, "#8c2b2b");
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, rect.width, rect.height);

        ctx.fillStyle = "rgba(255, 255, 255, 0.9)";
        ctx.font = "600 18px system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("Gratta il " + day, rect.width / 2, rect.height / 2);

        canvas.classList.remove("is-hidden");
        canvas.style.pointerEvents = "auto";
      }

      function scratch(e) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const radius = 18;

        ctx.globalCompositeOperation = "destination-out";
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2);
        ctx.fill();
      }

      function computeScratchedPercent() {
        try {
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;
          let transparent = 0;
          const total = data.length / 4;
          for (let i = 3; i < data.length; i += 4) {
            if (data[i] === 0) transparent++;
          }
          return (transparent / total) * 100;
        } catch {
          return 0;
        }
      }

      function revealIfEnough() {
        const percent = computeScratchedPercent();
        if (percent > 55) {
          canvas.classList.add("is-hidden");
          canvas.style.pointerEvents = "none";
          revealed[String(day)] = true;
          saveRevealed(revealed);
        }
      }

      canvas.addEventListener("pointerdown", (e) => {
        e.preventDefault();
        isDrawing = true;
        try { canvas.setPointerCapture(e.pointerId); } catch {}
        scratch(e);
      });

      canvas.addEventListener("pointermove", (e) => {
        if (!isDrawing) return;
        e.preventDefault();
        scratch(e);
      });

      canvas.addEventListener("pointerup", (e) => {
        if (!isDrawing) return;
        isDrawing = false;
        try { canvas.releasePointerCapture(e.pointerId); } catch {}
        revealIfEnough();
      });

      canvas.addEventListener("pointerleave", () => {
        if (!isDrawing) return;
        isDrawing = false;
        revealIfEnough();
      });

      function resetOverlay() {
        revealed[String(day)] = false;
        saveRevealed(revealed);
        initOverlay();
      }

      function revealNow() {
        revealed[String(day)] = true;
        saveRevealed(revealed);
        canvas.classList.add("is-hidden");
        canvas.style.pointerEvents = "none";
      }

      scratchAPIs.set(day, { resetOverlay, revealNow, initOverlay });

      if (revealed[String(day)]) {
        canvas.classList.add("is-hidden");
        canvas.style.pointerEvents = "none";
      } else {
        initOverlay();
      }
    }

    function setupAdmin() {
      const params = new URLSearchParams(window.location.search);
      const isAdmin = params.get("test") === "fra";
      const panel = document.getElementById("admin-panel");
      if (!panel || !isAdmin) return;

      panel.classList.remove("hidden");
      panel.hidden = false;

      const daySelect = document.getElementById("admin-day-select");
      const imgInput = document.getElementById("admin-image-url");
      const captionInput = document.getElementById("admin-caption");
      const saveBtn = document.getElementById("admin-save");
      const clearBtn = document.getElementById("admin-clear");
      const resetScratchBtn = document.getElementById("admin-reset-scratch");
      const closeBtn = document.getElementById("admin-close");

      DAYS.forEach((day) => {
        const opt = document.createElement("option");
        opt.value = String(day);
        opt.textContent = "Giorno " + day;
        daySelect.appendChild(opt);
      });

      function currentDay() {
        return String(daySelect.value);
      }

      function loadDayIntoForm() {
        const day = currentDay();
        const g = getGiftForDay(day);
        imgInput.value = g.imageUrl || "";
        captionInput.value = g.caption || "";
      }

      daySelect.addEventListener("change", loadDayIntoForm);

      saveBtn.addEventListener("click", () => {
        const day = currentDay();
        overrides[day] = {
          imageUrl: imgInput.value.trim(),
          caption: captionInput.value.trim(),
        };
        saveOverrides(overrides);
        renderGift(parseInt(day, 10));
        alert("Salvato (override locale) ✔️\n\nPer renderlo definitivo su GitHub, aggiorna gifts.json nel repo.");
      });

      clearBtn.addEventListener("click", () => {
        const day = currentDay();
        delete overrides[day];
        saveOverrides(overrides);
        renderGift(parseInt(day, 10));
        alert("Override locale cancellato.\n(Se esiste in gifts.json remoto, tornerà visibile.)");
      });

      resetScratchBtn.addEventListener("click", () => {
        const dayNum = parseInt(currentDay(), 10);
        const api = scratchAPIs.get(dayNum);
        if (api) api.resetOverlay();
        alert("Grattata resettata.");
      });

      closeBtn.addEventListener("click", () => {
        panel.classList.toggle("collapsed");
      });

      loadDayIntoForm();
    }

    async function boot() {
      createCalendar();

      // 1) fetch remoto
      remoteGifts = await fetchRemoteConfig();

      // 2) render + scratch
      DAYS.forEach((day) => {
        renderGift(day);
        setupScratchForDay(day);
      });

      // 3) admin
      setupAdmin();
    }

    window.addEventListener("load", boot);
  })();
</script>
